<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<title>Globe interactif avec jour/nuit, capitales, pays, trajets</title>
<style>
  html, body, #main {
    margin: 0; padding: 0; width: 100%; height: 100%;
    overflow: hidden;
    background: url('./starfield.jpg') no-repeat center center fixed;
    background-size: cover;
  }
  #main {
    position: relative;
  }
  /* Style bouton switch jour/nuit */
  #switcher {
    position: absolute;
    top: 20px; left: 20px;
    width: 100px; height: 40px;
    background: linear-gradient(90deg, #ffe066 50%, #4a90e2 50%);
    border-radius: 20px;
    cursor: pointer;
    box-shadow: 0 0 8px rgba(0,0,0,0.3);
    user-select: none;
    display: flex;
    align-items: center;
    padding: 0 5px;
    font-weight: bold;
    color: #333;
    font-family: Arial, sans-serif;
  }
  #switcher.night {
    background: linear-gradient(90deg, #4a90e2 50%, #ffe066 50%);
    color: #222;
  }
  #switcher .icon {
    flex: 1;
    text-align: center;
    font-size: 20px;
    pointer-events: none;
  }
  #switcher .sun {
    order: 0;
  }
  #switcher .moon {
    order: 1;
  }
  #switcher.night .sun {
    order: 1;
    opacity: 0.5;
  }
  #switcher.night .moon {
    order: 0;
    opacity: 1;
  }
</style>

<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/echarts-gl@2/dist/echarts-gl.min.js"></script>
</head>
<body>
<div id="main"></div>
<div id="switcher" title="Changer entre jour et nuit">
  <div class="icon sun">‚òÄÔ∏è</div>
  <div class="icon moon">üåô</div>
</div>

<script>
(async function(){
  const dayTexture = './earth.jpg';
  const nightTexture = './night.jpg';
  const cloudTexture = './clouds.png';

  const chart = echarts.init(document.getElementById('main'));

  async function loadGeojson(url) {
    console.log("Chargement de ", url);
    const res = await fetch(url);
    if(!res.ok) throw new Error("Erreur chargement " + url + " code: " + res.status);
    const json = await res.json();
    console.log("Donn√©es charg√©es depuis", url, json);
    return json;
  }

  const countries = await loadGeojson('./countries_10m_new.geojson');
  const trajets = await loadGeojson('./ALLLINE_TRAJET_wgs.geojson');
  const capitals = await loadGeojson('./capitals.geojson');

  // Pr√©paration des lignes des pays (fronti√®res)
  const countryLines = [];
  countries.features.forEach(feature => {
    if(!feature.geometry) return;
    if(feature.geometry.type === 'MultiPolygon') {
      feature.geometry.coordinates.forEach(polygon => {
        polygon.forEach(ring => {
          countryLines.push({
            coords: ring.map(c => [c[0], c[1]]),
            lineStyle: { color: '#fff', width: 1 }
          });
        });
      });
    } else if(feature.geometry.type === 'Polygon') {
      feature.geometry.coordinates.forEach(ring => {
        countryLines.push({
          coords: ring.map(c => [c[0], c[1]]),
          lineStyle: { color: '#fff', width: 1 }
        });
      });
    }
  });

  // Capitales - points blancs avec contour noir fin, opacity 0 (invisible)
  const capitalPoints = capitals.features.map(f => ({
    name: f.properties.name || '',
    value: [f.geometry.coordinates[0], f.geometry.coordinates[1], 0],
    symbolSize: 5,
    itemStyle: {
      color: '#fff',
      borderColor: '#000',
      borderWidth: 0.5,
      opacity: 0
    }
  }));

  // Couleurs par trajet
  const couleurParTrajet = {
    "trajet1": "#1f77b4",
    "trajet2": "#ff7f0e",
    "trajet3": "#2ca02c",
    "trajet4": "#d62728",
  };

  // Trajets lignes, d√©compose MultiLineString
  const trajetLines = [];
  trajets.features.forEach(f => {
    if(!f.geometry) return;
    const type = f.geometry.type;
    const trajetType = f.properties?.trajet || "default";
    const color = couleurParTrajet[trajetType] || '#00ffff';

    if(type === 'LineString') {
      trajetLines.push({
        coords: f.geometry.coordinates.map(c => [c[0], c[1]]),
        lineStyle: { color: color, width: 3, opacity: 1 }
      });
    } else if(type === 'MultiLineString') {
      f.geometry.coordinates.forEach(line => {
        trajetLines.push({
          coords: line.map(c => [c[0], c[1]]),
          lineStyle: { color: color, width: 3, opacity: 1 }
        });
      });
    }
  });

  // Initial position au-dessus de l'Europe (longitude, latitude)
  const initView = {
    center: [10, 50], // approximatif (France-Allemagne)
    distance: 150
  };

  // Options du globe et s√©ries
  const option = {
    legend: {
      show: true,
      orient: 'vertical',
      right: 20,
      top: 20,
      textStyle: { color: '#fff' },
      selected: {
        'Pays': true,
        'Trajets': true,
        'Capitales': false
      }
    },
    globe: {
      baseTexture: dayTexture,
      nightTexture: nightTexture,
      shading: 'lambert',
      postEffect: { enable: true },
      light: {
        main: { intensity: 1, shadow: true, shadowQuality: 'high' },
        ambient: { intensity: 0.1 }
      },
      viewControl: {
        autoRotate: true,
        autoRotateSpeed: 3,
        targetCoord: initView.center,
        distance: initView.distance,
        zoomSensitivity: 2,
        rotateSensitivity: 2,
        panSensitivity: 2,
        // Pour bien tourner sans probl√®me
        animationDurationUpdate: 500
      },
      layers: [
        { type: 'overlay', texture: cloudTexture, shading: 'lambert', distance: 2.0, blendTo: 'emission', visibility: true }
      ]
    },
    series: [
      {
        name: 'Pays',
        type: 'lines3D',
        coordinateSystem: 'globe',
        blendMode: 'lighter',
        lineStyle: { width: 1, opacity: 0.9, color: '#fff' },
        data: countryLines,
        silent: true
      },
      {
        name: 'Capitales',
        type: 'scatter3D',
        coordinateSystem: 'globe',
        symbol: 'circle',
        symbolSize: 5,
        itemStyle: { color: '#fff', borderColor: '#000', borderWidth: 0.5, opacity: 0 },
        data: capitalPoints,
        silent: true
      },
      {
        name: 'Trajets',
        type: 'lines3D',
        coordinateSystem: 'globe',
        blendMode: 'lighter',
        lineStyle: { width: 3, opacity: 1, color: '#00ffff' },
        data: trajetLines,
        silent: true
      }
    ]
  };

  chart.setOption(option);

  // G√©rer l‚Äôaffichage des capitales en fonction du zoom
  chart.getZr().on('wheel', () => {
    const optionNow = chart.getOption();
    const zoom = chart.getModel().getComponent('globe').getViewControl().distance;
    // Affiche capitales si zoom < 120 (plus proche), cache sinon
    const capitalesSeries = optionNow.series.find(s => s.name === 'Capitales');
    if(capitalesSeries) {
      const opacity = (zoom < 120) ? 1 : 0;
      capitalesSeries.itemStyle.opacity = opacity;
      capitalesSeries.data.forEach(p => p.itemStyle = p.itemStyle || {});
      capitalesSeries.data.forEach(p => p.itemStyle.opacity = opacity);
      chart.setOption({ series: optionNow.series });
    }
  });

  // Bouton switch jour/nuit
  const switcher = document.getElementById('switcher');
  let isNight = false;
  switcher.addEventListener('click', () => {
    isNight = !isNight;
    switcher.classList.toggle('night', isNight);
    updateNightMode(isNight);
  });

  function updateNightMode(night) {
    chart.setOption({
      globe: {
        baseTexture: night ? nightTexture : dayTexture,
        postEffect: night
          ? { enable: true, colorFilter: { enable: true, color: '#f1d56d' } }
          : { enable: true, colorFilter: { enable: false } },
        layers: [
          { type: 'overlay', texture: cloudTexture, shading: 'lambert', distance: 2.0, blendTo: 'emission', visibility: !night }
        ]
      }
    });
  }

  // initial appel pour √™tre s√ªr que tout est en jour au d√©part
  updateNightMode(false);
})();
</script>
</body>
</html>
