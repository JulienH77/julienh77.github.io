<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Globe 3D avec Légende</title>
<style>
    html, body {
        margin: 0;
        padding: 0;
        overflow: hidden;
        background: url('starfield.jpg') no-repeat center center fixed;
        background-size: cover;
    }
    #container {
        position: absolute;
        top: 0; left: 0;
        width: 100%; height: 100%;
    }
    .legend {
        position: absolute;
        top: 10px; left: 10px;
        background: rgba(255,255,255,0.8);
        padding: 10px;
        border-radius: 10px;
        font-family: Arial, sans-serif;
    }
    .legend label {
        display: block;
        margin: 5px 0;
    }
    .day-night-toggle {
        position: absolute;
        top: 10px; right: 10px;
        width: 60px; height: 30px;
        background: #ddd;
        border-radius: 15px;
        cursor: pointer;
        display: flex;
        align-items: center;
        padding: 3px;
    }
    .toggle-ball {
        width: 24px; height: 24px;
        background: yellow;
        border-radius: 50%;
        transition: transform 0.3s ease;
    }
    .night .toggle-ball {
        transform: translateX(30px);
        background: #444;
    }
</style>
<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/echarts-gl@2/dist/echarts-gl.min.js"></script>
</head>
<body>

<div id="container"></div>

<div class="legend">
    <label><input type="checkbox" id="countries"> Limites des pays</label>
    <label><input type="checkbox" id="trajets"> Trajets</label>
    <label><input type="checkbox" id="capitals"> Capitales</label>
</div>

<div class="day-night-toggle" id="toggle">
    <div class="toggle-ball"></div>
</div>

<script>
const chart = echarts.init(document.getElementById('container'));
let isNight = false;

// Charger textures
const dayTexture = 'earth.jpg';
const nightTexture = 'earth_night_yellow.jpg';
const moonTexture = 'moon-base.jpg';
const moonBump = 'moon-bump.jpg';

let option = {
    backgroundColor: 'transparent',
    globe: {
        baseTexture: dayTexture,
        heightTexture: '',
        displacementScale: 0,
        shading: 'lambert',
        environment: 'starfield.jpg',
        viewControl: {
            autoRotate: true,
            autoRotateSpeed: 3,
            targetCoord: [48.8566, 2.3522],
            alpha: 30,
            beta: -90
        },
        layers: []
    },
    series: []
};

chart.setOption(option);

// Charger GeoJSON et ajouter couches
Promise.all([
    fetch('countries_10m_new.geojson').then(r => r.json()),
    fetch('ALLLINE_TRAJET_wgs.geojson').then(r => r.json()),
    fetch('capitals.geojson').then(r => r.json())
]).then(([countriesData, trajetsData, capitalsData]) => {

    // Couche limites pays
    const countriesLayer = {
        type: 'lines3D',
        coordinateSystem: 'globe',
        data: countriesData.features.map(f => f.geometry.coordinates).flat(),
        lineStyle: { width: 1, color: 'white', opacity: 1 }
    };

    // Couche trajets
    const trajetsLayer = {
        type: 'lines3D',
        coordinateSystem: 'globe',
        data: trajetsData.features.map(f => f.geometry.coordinates).flat(),
        lineStyle: { width: 2, color: 'yellow', opacity: 0.8 }
    };

    // Couche capitales
    const capitalsLayer = {
        type: 'scatter3D',
        coordinateSystem: 'globe',
        symbolSize: 5,
        itemStyle: { color: 'red', borderWidth: 1, borderColor: '#000' },
        data: capitalsData.features.map(f => {
            const [lon, lat] = f.geometry.coordinates;
            return [lon, lat];
        })
    };

    // Gestion de la légende
    document.getElementById('countries').addEventListener('change', function() {
        updateSeries(this.checked, countriesLayer);
        updateGlobeBase();
    });
    document.getElementById('trajets').addEventListener('change', function() {
        updateSeries(this.checked, trajetsLayer);
    });
    document.getElementById('capitals').addEventListener('change', function() {
        updateSeries(this.checked, capitalsLayer);
    });

    function updateSeries(checked, layer) {
        let s = chart.getOption().series || [];
        s = s.filter(l => l.name !== layer.name);
        if (checked) {
            s.push(layer);
        }
        chart.setOption({ series: s });
    }

    function updateGlobeBase() {
        const countriesChecked = document.getElementById('countries').checked;
        chart.setOption({
            globe: {
                baseTexture: countriesChecked ? dayTexture : (isNight ? nightTexture : dayTexture),
                color: countriesChecked ? 'black' : 'black'
            }
        });
    }

    // Lune
    chart.setOption({
        globe: {
            layers: [
                {
                    type: 'overlay',
                    texture: moonTexture,
                    shading: 'realistic',
                    realisticMaterial: {
                        roughness: 0.9,
                        metalness: 0
                    },
                    displacementTexture: moonBump,
                    displacementScale: 0.05,
                    distance: 20,
                    size: 3 // dézoom
                }
            ]
        }
    });
});

// Bouton jour/nuit
document.getElementById('toggle').addEventListener('click', function() {
    isNight = !isNight;
    this.classList.toggle('night', isNight);
    chart.setOption({
        globe: {
            baseTexture: isNight ? nightTexture : dayTexture
        }
    });
});
</script>
</body>
</html>
