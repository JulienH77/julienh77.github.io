<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<title>Globe avec pays, capitales, trajets et nuages</title>
<style>
  html, body, #main {
    margin: 0; padding: 0; width: 100%; height: 100%;
    overflow: hidden;
  }
  body {
    background: url('./starfield.jpg') no-repeat center center fixed;
    background-size: cover;
  }
  #main {
    position: relative;
  }
</style>

<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/echarts-gl@2/dist/echarts-gl.min.js"></script>
</head>
<body>
<div id="main"></div>

<script>
(async function(){
  try {
    const earthTexture = './earth.jpg';
    const nightTexture = './night.jpg';
    const cloudTexture = './clouds.png';

    const chart = echarts.init(document.getElementById('main'));

    async function loadGeojson(url) {
      console.log("Chargement de ", url);
      const res = await fetch(url);
      if(!res.ok) throw new Error("Erreur chargement " + url + " code: " + res.status);
      const json = await res.json();
      console.log("Données chargées depuis", url, json);
      return json;
    }

    const countries = await loadGeojson('./countries_10m_new.geojson');
    const trajets = await loadGeojson('./ALLLINE_TRAJET_wgs.geojson');
    const capitals = await loadGeojson('./capitals.geojson');

    // Pays - frontières
    const countryLines = [];
    countries.features.forEach(feature => {
      if(!feature.geometry) return;
      if(feature.geometry.type === 'MultiPolygon') {
        feature.geometry.coordinates.forEach(polygon => {
          polygon.forEach(ring => {
            countryLines.push({
              coords: ring.map(c => [c[0], c[1]]),
              lineStyle: { color: '#fff', width: 1 }
            });
          });
        });
      } else if(feature.geometry.type === 'Polygon') {
        feature.geometry.coordinates.forEach(ring => {
          countryLines.push({
            coords: ring.map(c => [c[0], c[1]]),
            lineStyle: { color: '#fff', width: 1 }
          });
        });
      }
    });

    // Capitales - points jaunes
    const capitalPoints = capitals.features.map(f => ({
      name: f.properties.name || '',
      value: [f.geometry.coordinates[0], f.geometry.coordinates[1], 0],
      symbolSize: 10,
      itemStyle: { color: 'yellow' }
    }));

    // Couleurs par trajet
    const couleurParTrajet = {
      "trajet1": "#1f77b4",
      "trajet2": "#ff7f0e",
      "trajet3": "#2ca02c",
      "trajet4": "#d62728",
    };

    // Trajets lignes, on décompose MultiLineString
    const trajetLines = [];
    trajets.features.forEach(f => {
      if(!f.geometry) return;
      const type = f.geometry.type;
      const trajetType = f.properties?.trajet || "default";
      const color = couleurParTrajet[trajetType] || '#00ffff';

      if(type === 'LineString') {
        trajetLines.push({
          coords: f.geometry.coordinates.map(c => [c[0], c[1]]),
          lineStyle: { color: color, width: 3, opacity: 1 }
        });
      } else if(type === 'MultiLineString') {
        f.geometry.coordinates.forEach(line => {
          trajetLines.push({
            coords: line.map(c => [c[0], c[1]]),
            lineStyle: { color: color, width: 3, opacity: 1 }
          });
        });
      } else {
        console.warn("Type géométrique inconnu pour trajet:", type);
      }
    });

    console.log("Country lines count:", countryLines.length);
    console.log("Capital points count:", capitalPoints.length);
    console.log("Trajet lines count:", trajetLines.length);

    chart.setOption({
      backgroundColor: 'transparent',
      globe: {
        baseTexture: earthTexture,
        nightTexture: nightTexture,
        shading: 'lambert',
        postEffect: { enable: true },
        light: { main: { intensity: 1, shadow: true, shadowQuality: 'high' }, ambient: { intensity: 0.1 } },
        viewControl: { autoRotate: true, autoRotateSpeed: 3 },
        layers: [{ type: 'overlay', texture: cloudTexture, shading: 'lambert', distance: 2.0, blendTo: 'emission' }]
      },
      series: [
        {
          name: 'Pays',
          type: 'lines3D',
          coordinateSystem: 'globe',
          blendMode: 'lighter',
          lineStyle: { width: 1, opacity: 0.9 },
          data: countryLines
        },
        {
          name: 'Capitales',
          type: 'scatter3D',
          coordinateSystem: 'globe',
          symbol: 'circle',
          symbolSize: 10,
          itemStyle: { color: 'yellow', opacity: 1, borderWidth: 1, borderColor: 'black' },
          data: capitalPoints
        },
        {
          name: 'Trajets',
          type: 'lines3D',
          coordinateSystem: 'globe',
          blendMode: 'lighter',
          lineStyle: { width: 3, opacity: 1 },
          data: trajetLines
        }
      ]
    });
  }
  catch(e) {
    console.error("Erreur dans le script:", e);
  }
})();
</script>
</body>
</html>
