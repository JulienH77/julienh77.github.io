<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<title>Globe avec pays, capitales, trajets et lune</title>
<style>
  html, body, #main {
    margin: 0; padding: 0; width: 100%; height: 100%;
    overflow: hidden;
  }
  body {
    background: url('./starfield.jpg') no-repeat center center fixed;
    background-size: cover;
  }
  #main {
    position: relative;
    width: 100%;
    height: 100%;
  }
  #legendToggle {
    position: absolute;
    top: 10px;
    left: 10px;
    background: rgba(255,255,255,0.7);
    border: none;
    padding: 6px 12px;
    cursor: pointer;
    font-weight: bold;
    z-index: 1100;
    border-radius: 4px;
  }
  #legend {
    position: absolute;
    top: 50px;
    left: 10px;
    background: rgba(255,255,255,0.8);
    border-radius: 6px;
    padding: 10px 15px;
    font-family: Arial, sans-serif;
    font-size: 14px;
    display: none;
    z-index: 1100;
    user-select: none;
  }
  #legend label {
    display: flex;
    align-items: center;
    margin-bottom: 8px;
    cursor: pointer;
  }
  #legend input[type=checkbox] {
    margin-right: 8px;
  }
  #toggleDayNight {
    position: absolute;
    top: 10px;
    right: 10px;
    z-index: 1100;
  }
  /* Bouton jour/nuit style swipe */
  .switch {
    position: relative;
    display: inline-block;
    width: 70px;
    height: 34px;
  }
  .switch input {display:none;}
  .slider {
    position: absolute;
    cursor: pointer;
    top: 0; left: 0; right: 0; bottom: 0;
    background-color: #ccc;
    transition: 0.4s;
    border-radius: 34px;
  }
  .slider:before {
    position: absolute;
    content: "‚òÄÔ∏è";
    height: 26px; width: 26px;
    left: 4px; bottom: 4px;
    background-color: white;
    transition: 0.4s;
    border-radius: 50%;
    font-size: 20px;
    line-height: 26px;
    text-align: center;
  }
  input:checked + .slider {
    background-color: #f3d869; /* jaune doux pour nuit */
  }
  input:checked + .slider:before {
    transform: translateX(36px);
    content: "üåô";
  }
</style>

<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/echarts-gl@2/dist/echarts-gl.min.js"></script>
</head>
<body>
<button id="legendToggle">Afficher la l√©gende</button>
<div id="legend">
  <label><input type="checkbox" id="toggleCountries" /> Limites des pays</label>
  <label><input type="checkbox" id="toggleCapitals" /> Capitales</label>
  <label><input type="checkbox" id="toggleTrajets" /> Trajets</label>
</div>

<div id="toggleDayNight">
  <label class="switch">
    <input type="checkbox" id="dayNightSwitch" />
    <span class="slider"></span>
  </label>
</div>

<div id="main"></div>

<script>
(async function(){
  const earthTextureDay = './earth.jpg';
  const earthTextureNight = './earth_night_yellow.jpg';
  const cloudTexture = './clouds.png';
  const moonTexture = './moon-base.jpg';
  const moonBumpTexture = './moon-bump.jpg';

  const chart = echarts.init(document.getElementById('main'));

  async function loadGeojson(url) {
    const res = await fetch(url);
    if(!res.ok) throw new Error("Erreur chargement " + url + " code: " + res.status);
    return res.json();
  }

  const countries = await loadGeojson('./countries_10m_new.geojson');
  const trajets = await loadGeojson('./ALLLINE_TRAJET_wgs.geojson');
  const capitals = await loadGeojson('./capitals.geojson');

  // Construire les lignes des pays (blanc)
  const countryLines = [];
  countries.features.forEach(feature => {
    if(!feature.geometry) return;
    if(feature.geometry.type === 'MultiPolygon') {
      feature.geometry.coordinates.forEach(polygon => {
        polygon.forEach(ring => {
          countryLines.push({
            coords: ring.map(c => [c[0], c[1]]),
            lineStyle: { color: '#fff', width: 1 }
          });
        });
      });
    } else if(feature.geometry.type === 'Polygon') {
      feature.geometry.coordinates.forEach(ring => {
        countryLines.push({
          coords: ring.map(c => [c[0], c[1]]),
          lineStyle: { color: '#fff', width: 1 }
        });
      });
    }
  });

  // Capitales (petits points blancs avec contour noir)
  const capitalPoints = capitals.features.map(f => ({
    name: f.properties.name || '',
    value: [f.geometry.coordinates[0], f.geometry.coordinates[1], 0],
    symbolSize: 6,
    itemStyle: { color: 'white', borderWidth: 0.5, borderColor: 'black' }
  }));

  // Trajets lignes
  const couleurParTrajet = {
    "trajet1": "#1f77b4",
    "trajet2": "#ff7f0e",
    "trajet3": "#2ca02c",
    "trajet4": "#d62728",
  };

  const trajetLines = [];
  trajets.features.forEach(f => {
    if(!f.geometry) return;
    const type = f.geometry.type;
    const trajetType = f.properties?.trajet || "default";
    const color = couleurParTrajet[trajetType] || '#00ffff';

    if(type === 'LineString') {
      trajetLines.push({
        coords: f.geometry.coordinates.map(c => [c[0], c[1]]),
        lineStyle: { color: color, width: 3, opacity: 1 }
      });
    } else if(type === 'MultiLineString') {
      f.geometry.coordinates.forEach(line => {
        trajetLines.push({
          coords: line.map(c => [c[0], c[1]]),
          lineStyle: { color: color, width: 3, opacity: 1 }
        });
      });
    }
  });

  // Variables de visibilit√© des couches, initialement false (donc non affich√©)
  let showCountries = false;
  let showCapitals = false;
  let showTrajets = false;

  // Param√®tres de base pour le globe (noir par d√©faut)
  const baseGlobeOption = {
    globe: {
      baseTexture: earthTextureDay,
      shading: 'lambert',
      light: {
        main: { intensity: 1, shadow: true, shadowQuality: 'high' },
        ambient: { intensity: 0.1 }
      },
      viewControl: {
        autoRotate: true,
        autoRotateSpeed: 1,
        distance: 150,
        minDistance: 100,
        maxDistance: 300,
        // Pas de zoom forc√© sur l'Europe apr√®s d√©marrage
        center: [10, 50]
      },
      // Pas de nuages du tout
      layers: []
    },
    backgroundColor: 'black',
    series: []
  };

  // Lune (petite, d√©zoom√©e, position fixe sud-ouest)
  const moonSeries = {
    name: 'Lune',
    type: 'globe',
    globeRadius: 20,
    silent: true,
    baseTexture: moonTexture,
    heightTexture: moonBumpTexture,
    shading: 'lambert',
    light: {
      main: { intensity: 1 },
      ambient: { intensity: 0.2 }
    },
    viewControl: {
      rotateSensitivity: 0,
      zoomSensitivity: 0,
      panSensitivity: 0
    },
    globeCenter: [-90, -30], // Position sud-ouest
    roam: false,
    z: 10,
  };

  // Initialiser l‚Äôoption
  let option = JSON.parse(JSON.stringify(baseGlobeOption));
  option.series.push(moonSeries);

  chart.setOption(option);

  // Fonction pour mettre √† jour le globe selon couches et fond jour/nuit
  function updateGlobe() {
    const night = document.getElementById('dayNightSwitch').checked;
    option.globe.baseTexture = night ? earthTextureNight : earthTextureDay;
    option.backgroundColor = night ? '#222200' : 'black';
    option.globe.layers = night ? [] : [];

    // S√©ries √† afficher
    option.series = option.series.filter(s => s.name === 'Lune'); // garder lune

    if(showCountries) {
      option.series.push({
        name: 'Pays',
        type: 'lines3D',
        coordinateSystem: 'globe',
        blendMode: 'lighter',
        lineStyle: { width: 1, opacity: 0.9, color: '#fff' },
        data: countryLines
      });
    }
    if(showCapitals) {
      option.series.push({
        name: 'Capitales',
        type: 'scatter3D',
        coordinateSystem: 'globe',
        symbolSize: 6,
        itemStyle: {
          color: 'white',
          borderColor: 'black',
          borderWidth: 0.5
        },
        data: capitalPoints
      });
    }
    if(showTrajets) {
      option.series.push({
        name: 'Trajets',
        type: 'lines3D',
        coordinateSystem: 'globe',
        blendMode: 'lighter',
        lineStyle: { width: 3, opacity: 1 },
        data: trajetLines
      });
    }
    chart.setOption(option);
  }

  // Gestion des checkbox (aucune coch√©e au d√©part)
  document.getElementById('toggleCountries').checked = false;
  document.getElementById('toggleCapitals').checked = false;
  document.getElementById('toggleTrajets').checked = false;

  // Event listeners
  document.getElementById('toggleCountries').addEventListener('change', e => {
    showCountries = e.target.checked;
    updateGlobe();
  });
  document.getElementById('toggleCapitals').addEventListener('change', e => {
    showCapitals = e.target.checked;
    updateGlobe();
  });
  document.getElementById('toggleTrajets').addEventListener('change', e => {
    showTrajets = e.target.checked;
    updateGlobe();
  });

  // Bouton toggle l√©gende
  const legend = document.getElementById('legend');
  document.getElementById('legendToggle').addEventListener('click', () => {
    if(legend.style.display === 'none' || legend.style.display === '') {
      legend.style.display = 'block';
    } else {
      legend.style.display = 'none';
    }
  });

  // Bouton jour/nuit
  document.getElementById('dayNightSwitch').addEventListener('change', () => {
    updateGlobe();
  });

  // Au chargement : rien dans la l√©gende affich√©, globe au jour avec earth.jpg, zoom fixe sur Europe sans zoom forc√©
  chart.getModel().getComponent('globe').setViewControl({
    autoRotate: true,
    autoRotateSpeed: 1,
    distance: 150,
    minDistance: 100,
    maxDistance: 300,
    center: [10, 50],
    zoom: 100
  });

  // Pas de zoom forc√© quand on clique sur les couches
  // Rien √† faire car updateGlobe ne modifie pas le centre ni zoom
})();
</script>
</body>
</html>
