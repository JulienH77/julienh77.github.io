<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Mes vacances</title>
<style>
  html,body,#root { height:100%; margin:0; padding:0; }
  body{
    background: url('./starfield.jpg') no-repeat center center fixed;
    background-size: cover;
    font-family: Inter, Arial, sans-serif;
  }
  #root { position:relative; width:100%; height:100%; overflow:hidden; }
  #globeContainer { width:100%; height:100%; }

  /* Toggle jour/nuit */
  #toggle {
    position:absolute; top:14px; left:14px;
    width:100px; height:40px; border-radius:22px;
    display:flex; align-items:center; justify-content:space-between;
    padding:4px 8px; cursor:pointer; z-index:120; user-select:none;
    background: linear-gradient(90deg,#ffe066 50%, #4a90e2 50%);
    box-shadow: 0 6px 18px rgba(0,0,0,0.25);
  }
  #toggle.night { background: linear-gradient(90deg,#4a90e2 50%, #ffe066 50%); }
  #toggle .ball {
    position:absolute; top:4px; left:4px;
    width:32px; height:32px; border-radius:50%;
    background:#ffd54a;
    box-shadow:0 6px 16px rgba(255,213,74,0.28);
    transition:left .28s, background .28s;
  }
  #toggle.night .ball { left:64px; background:#f1d56d; }

  /* Toggle relief (rond) */
  #toggleRelief {
    position: absolute;
    top: 80px;
    left: 18px;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 120;
    user-select: none;
    background: rgba(255,255,255,0.9);
    box-shadow: 0 4px 10px rgba(0,0,0,0.25);
    transition: background 0.2s, transform 0.15s;
  }
  #toggleRelief.active { background: rgba(180,255,180,0.9); }
  #toggleRelief:active { transform: scale(0.95); }

  /* Toggle nuages (rond) */
  #toggleClouds {
    position: absolute;
    top: 134px;
    left: 18px;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 120;
    user-select: none;
    background: rgba(255,255,255,0.9);
    box-shadow: 0 4px 10px rgba(0,0,0,0.25);
    transition: background 0.2s, transform 0.15s;
  }
  #toggleClouds.active { background: rgba(180,220,255,0.9); }
  #toggleClouds:active { transform: scale(0.95); }

  /* Bouton carré fond du jour */
  #toggleDayBase {
    position: absolute;
    left: 18px;
    bottom: 18px;
    width: 48px;
    height: 48px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 120;
    user-select: none;
    background: rgba(255,255,255,0.95);
    box-shadow: 0 6px 18px rgba(0,0,0,0.25);
    font-weight: 700;
    font-size: 12px;
    text-align: center;
    line-height: 1.1;
  }
  #toggleDayBase:active { transform: scale(0.97); }

  /* Légende */
  #legend {
    position:absolute; top:14px; right:14px; z-index:120;
    background: rgba(255,255,255,0.92);
    padding:10px 12px; border-radius:10px;
    min-width:160px; box-shadow:0 6px 18px rgba(0,0,0,0.18);
  }
  #legend label { display:flex; align-items:center; gap:10px; font-weight:600; }
  #legend input[type=checkbox] { width:16px; height:16px; }

  /* Lune */
  #moonPreview {
    position:absolute; bottom:14px; right:14px;
    width:140px; height:140px; z-index:110; border-radius:50%;
    overflow:hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.6); background:black;
  }

  /* Popup stats */
  #trajetPopup {
    position:absolute; bottom:20px; left:20px;
    background:rgba(0,0,0,0.85); color:white;
    padding:10px 14px; border-radius:8px;
    font-size:14px; line-height:1.4; max-width:300px;
    display:none; z-index:200;
  }
</style>
<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/echarts-gl@2/dist/echarts-gl.min.js"></script>
</head>
<body>
<div id="root">
  <div id="globeContainer" class="echarts-for-globe"></div>
  <div id="toggle" role="button"><svg class="sun" viewBox="0 0 24 24"><circle cx="12" cy="12" r="5" fill="#FFD43B"/></svg><svg class="moon" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 0112.21 3 7 7 0 1021 12.79z" fill="#FFDD66"/></svg><div class="ball"></div></div>
  <div id="toggleRelief"><svg viewBox="0 0 24 24"><path d="M3 20l5-9 4 7 5-10 5 12z" fill="#444"/><path d="M3 20h18v1H3z" fill="#777"/></svg></div>
  <div id="toggleClouds" class="active"><svg viewBox="0 0 24 24" width="22" height="22"><path d="M6 19h11a4 4 0 0 0 0-8 5 5 0 0 0-9.8-1.7A4 4 0 0 0 6 19z" fill="#4a90e2"/></svg></div>
  <div id="toggleDayBase">EARTH</div>
  <div id="legend">
    <label><input id="chkPays" type="checkbox"> Limites (Pays)</label>
    <label id="trajetsLabel"><input id="chkTrajets" type="checkbox"> Trajets <button type="button" id="expandTrajets">▼</button></label>
    <div id="trajetList" style="margin-left:20px; display:none;"></div>
    <label><input id="chkCapitales" type="checkbox"> Capitales</label>
  </div>
  <div id="moonPreview"></div>
  <div id="trajetPopup"></div>
</div>

<script>
(async function(){
  const PATH_EARTH_DAY_1 = './earth.jpg';
  const PATH_EARTH_DAY_2 = './world.topo.bathy.200401.jpg';
  const CLOUDS = './clouds.png';
  const PATH_EARTH_NIGHT_RAW = './night.jpg';
  const PATH_STARFIELD = './starfield.jpg';
  const PATH_MOON_BASE = './moon-base.jpg';
  const PATH_MOON_BUMP = './moon-bump.jpg';
  const PATH_COUNTRIES = './countries_10m_new.geojson';
  const PATH_TRAJETS = './ALLLINE_TRAJET_wgs.geojson';
  const PATH_CAPITALS = './capitals.geojson';
  const PATH_EARTH_BUMP = './world.topo.bathy.200401.jpg';

  const loadJSON = url => fetch(url).then(r=>r.json());
  const normalizeLng = lng => ((lng + 180) % 360) - 180;

  const linesFromPolygonGeom = g => {
    const out = [];
    if(g?.type === 'Polygon') g.coordinates.forEach(r => out.push({ coords: r.map(([x,y])=>[normalizeLng(x),y,0.001]) }));
    if(g?.type === 'MultiPolygon') g.coordinates.forEach(p => p.forEach(r => out.push({ coords: r.map(([x,y])=>[normalizeLng(x),y,0.001]) })));
    return out;
  };
  const extractLinesFromFeature = f => {
    const out = [];
    if(!f.geometry) return out;
    if(f.geometry.type === 'LineString') out.push({ coords: f.geometry.coordinates.map(([x,y])=>[normalizeLng(x),y]) });
    if(f.geometry.type === 'MultiLineString') f.geometry.coordinates.forEach(l => out.push({ coords: l.map(([x,y])=>[normalizeLng(x),y]) }));
    if(f.geometry.type === 'Polygon' || f.geometry.type === 'MultiPolygon') out.push(...linesFromPolygonGeom(f.geometry));
    return out;
  };

  const [countriesGeo, trajetsGeo, capitalsGeo] = await Promise.all([
    loadJSON(PATH_COUNTRIES),
    loadJSON(PATH_TRAJETS),
    loadJSON(PATH_CAPITALS)
  ]);

  const countryLines = [];
  countriesGeo.features.forEach(f => countryLines.push(...linesFromPolygonGeom(f.geometry)));

  const mapColor = { avion:'#0da2ff', train:'#ee0020', bus:'#009c27', voiture:'#900dff' };
  const trajetLines = trajetsGeo.features.flatMap(f =>
    extractLinesFromFeature(f).map(l => ({
      ...l,
      lineStyle:{ color: mapColor[f.properties?.trajet?.toLowerCase()] || '#00ffff', width:3, opacity:0.95 },
      properties: f.properties
    }))
  );

  const trajetNames = [...new Set(trajetLines.map(t => t.properties?.nom || t.properties?.trajet || 'Sans nom'))];

  let state = { showPays:false, showTrajets:false, showCapitales:false, showNuages:true, showRelief:false, dayBase:'earth', isNight:false, visibleTrajets:new Set(trajetNames) };

  const trajetListEl = document.getElementById('trajetList');
  trajetNames.forEach(name=>{
    const id = 'trajet_' + name.replace(/\s+/g,'_');
    const div = document.createElement('div');
    div.innerHTML = `<label><input type="checkbox" id="${id}" checked> ${name}</label>`;
    trajetListEl.appendChild(div);
    document.getElementById(id).addEventListener('change', e=>{
      if(e.target.checked) state.visibleTrajets.add(name); else state.visibleTrajets.delete(name);
      refresh();
    });
  });
  document.getElementById('expandTrajets').addEventListener('click', ()=>trajetListEl.style.display = trajetListEl.style.display==='none'?'block':'none');

  const capitalPoints = capitalsGeo.features.map(f=>{
    const [x,y] = f.geometry.coordinates;
    return { name: f.properties?.city||'', value:[normalizeLng(x),y,0] };
  });

  const globeChart = echarts.init(document.getElementById('globeContainer'), null, { renderer:'webgl' });
  const moonChart  = echarts.init(document.getElementById('moonPreview'), null, { renderer:'webgl' });

  function makeOption(s) {
    const series = [];
    if(s.showPays) series.push({ name:'Pays', type:'lines3D', coordinateSystem:'globe', polyline:true, data:countryLines, lineStyle:{ color:'#f0f0f0', width:1, opacity:0.98 } });
    if(s.showTrajets) series.push({ name:'Trajets', type:'lines3D', coordinateSystem:'globe', polyline:true, data: trajetLines.filter(t=>state.visibleTrajets.has(t.properties?.nom || t.properties?.trajet || 'Sans nom')) });
    if(s.showCapitales) series.push({ name:'Capitales', type:'scatter3D', coordinateSystem:'globe', symbol:'rect', symbolSize:6, itemStyle:{ color:'#fff', borderColor:'#000', borderWidth:1 }, label:{ show:true, formatter:p=>p.name, position:'top', distance:2, textStyle:{ fontSize:10, color:'#fff', backgroundColor:'rgba(0,0,0,0.35)', padding:[2,4], borderRadius:3 } }, data:capitalPoints });

    const baseDay = (s.dayBase === 'earth') ? PATH_EARTH_DAY_1 : PATH_EARTH_DAY_2;
    const layers = [
      { type:'blend', blendTo:'emission', texture: PATH_EARTH_NIGHT_RAW, intensity:1 }
    ];
    if(s.showNuages) layers.push({ type:'overlay', texture:CLOUDS, shading:'lambert', distance:1 });

    return {
      backgroundColor: 'transparent',
      globe: {
        baseTexture: baseDay,
        heightTexture: s.showRelief ? PATH_EARTH_BUMP : undefined,
        displacementScale: 0.025,
        shading: 'realistic',
        environment: PATH_STARFIELD,
        postEffect: { enable:false },
        light: { ambient:{ intensity:0.2 }, main:{ intensity:1.0, alpha:0, beta: s.isNight ? 180 : 0 } },
        atmosphere:{ show:true, color:'#a1a1a1', offset:4 },
        viewControl: { autoRotate:false, autoRotateSpeed:0.5 },
        layers
      },
      series
    };
  }

  function refresh(){ globeChart.setOption(makeOption(state), { notMerge:true }); }

  document.getElementById('toggle').addEventListener('click', ()=>{
    state.isNight = !state.isNight;
    document.getElementById('toggle').classList.toggle('night', state.isNight);
    refresh();
  });
  document.getElementById('toggleRelief').addEventListener('click', ()=>{
    state.showRelief = !state.showRelief;
    document.getElementById('toggleRelief').classList.toggle('active', state.showRelief);
    refresh();
  });
  document.getElementById('toggleClouds').addEventListener('click', ()=>{
    state.showNuages = !state.showNuages;
    document.getElementById('toggleClouds').classList.toggle('active', state.showNuages);
    refresh();
  });
  function updateDayBaseButtonLabel(){ document.getElementById('toggleDayBase').textContent = (state.dayBase === 'earth') ? 'EARTH' : 'TOPO'; }
  document.getElementById('toggleDayBase').addEventListener('click', ()=>{ state.dayBase = (state.dayBase === 'earth') ? 'topo' : 'earth'; updateDayBaseButtonLabel(); refresh(); });
  updateDayBaseButtonLabel();

  [['Pays', 'chkPays'], ['Trajets', 'chkTrajets'], ['Capitales', 'chkCapitales']].forEach(([n,id])=>{
    document.getElementById(id).addEventListener('change', e=>{ state['show'+n] = e.target.checked; refresh(); });
  });

  globeChart.on('click', params=>{
    const popupEl = document.getElementById('trajetPopup');
    if(params.seriesName === 'Trajets' && params.data?.properties){
      const p = params.data.properties;
      popupEl.innerHTML = `<strong>Trajet:</strong> ${p.trajet||''}<br/><strong>Date début:</strong> ${p.date_deb||''}<br/><strong>Date fin:</strong> ${p.date_fin||''}<br/><strong>Durée:</strong> ${p.duree||''}<br/><strong>Distance:</strong> ${p.distanceKM||''} km`;
      popupEl.style.display = 'block';
    } else popupEl.style.display = 'none';
  });

  refresh();

  moonChart.setOption({
    backgroundColor: 'transparent',
    globe: {
      baseTexture: PATH_MOON_BASE,
      heightTexture: PATH_MOON_BUMP,
      shading: 'lambert',
      environment: PATH_STARFIELD,
      light: { main:{ intensity:0.9 }, ambient:{ intensity:0.1 } },
      viewControl: { autoRotate:true, autoRotateSpeed:1.6, distance:220 }
    },
    series:[]
  });
})();
</script>
</body>
</html>
