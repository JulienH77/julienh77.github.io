<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Globe ECharts</title>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            background: black;
        }
        #main {
            height: 100%;
            width: 100%;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts-gl@2/dist/echarts-gl.min.js"></script>
</head>
<body>
<div id="main"></div>
<script>
// === Fonctions utilitaires ===
function normalizeLng(lng) {
    return ((lng + 180) % 360) - 180;
}

function polygonToLines(geojson) {
    let lines = [];

    geojson.features.forEach(feature => {
        const geom = feature.geometry;
        if (!geom) return;

        if (geom.type === "Polygon") {
            geom.coordinates.forEach(ring => {
                let line = ring.map(coord => [normalizeLng(coord[0]), coord[1]]);
                lines.push(line);
            });
        } else if (geom.type === "MultiPolygon") {
            geom.coordinates.forEach(polygon => {
                polygon.forEach(ring => {
                    let line = ring.map(coord => [normalizeLng(coord[0]), coord[1]]);
                    lines.push(line);
                });
            });
        }
    });

    return lines;
}

// === Chargement des donnÃ©es ===
Promise.all([
    fetch('countries.geojson').then(res => res.json()),
    fetch('capitals.geojson').then(res => res.json()),
    fetch('routes.geojson').then(res => res.json())
]).then(([countriesData, capitalsData, routesData]) => {

    const countriesLines = polygonToLines(countriesData);

    const capitals = capitalsData.features.map(f => ({
        name: f.properties.city,
        value: [normalizeLng(f.geometry.coordinates[0]), f.geometry.coordinates[1], 0]
    }));

    const routes = routesData.features.map(f => ({
        coords: f.geometry.coordinates.map(c => [normalizeLng(c[0]), c[1]])
    }));

    const chart = echarts.init(document.getElementById('main'));

    chart.setOption({
        backgroundColor: '#000',
        globe: {
            baseTexture: 'https://cdn.jsdelivr.net/npm/echarts-gl@latest/examples/data-gl/asset/world.topo.bathy.200401.jpg',
            heightTexture: 'https://cdn.jsdelivr.net/npm/echarts-gl@latest/examples/data-gl/asset/bathymetry_bw_composite_4k.jpg',
            shading: 'lambert',
            viewControl: {
                autoRotate: false,
                targetCoord: [0, 0],
                zoomSensitivity: 2
            },
            light: {
                main: { intensity: 1.2 },
                ambient: { intensity: 0.4 }
            }
        },
        series: [
            {
                type: 'lines3D',
                name: 'countries',
                coordinateSystem: 'globe',
                polyline: true,
                data: countriesLines,
                lineStyle: {
                    color: 'purple',
                    width: 1
                }
            },
            {
                type: 'scatter3D',
                name: 'capitals',
                coordinateSystem: 'globe',
                symbol: 'pin',
                symbolSize: 10,
                label: {
                    show: true,
                    formatter: '{b}',
                    position: 'top',
                    color: '#fff',
                    fontSize: 10
                },
                itemStyle: { color: 'red' },
                data: capitals
            },
            {
                type: 'lines3D',
                name: 'routes',
                coordinateSystem: 'globe',
                effect: {
                    show: true,
                    trailWidth: 2,
                    trailLength: 0.2,
                    trailOpacity: 1,
                    trailColor: 'yellow'
                },
                blendMode: 'lighter',
                lineStyle: {
                    color: 'yellow',
                    width: 1,
                    opacity: 0.6
                },
                data: routes
            }
        ]
    });

});
</script>
</body>
</html>
