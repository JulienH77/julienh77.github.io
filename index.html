<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<title>Globe amélioré</title>
<style>
  html, body, #main {
    margin: 0; padding: 0; width: 100%; height: 100%;
    overflow: hidden;
    background: url('./starfield.jpg') no-repeat center center fixed;
    background-size: cover;
  }
  #main { position: relative; }

  #switcher {
    position: absolute;
    top: 10px; right: 10px;
    background: rgba(0,0,0,0.5);
    padding: 8px 12px;
    border-radius: 5px;
    color: white;
    cursor: pointer;
    user-select: none;
    font-family: sans-serif;
    z-index: 10;
  }
</style>

<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/echarts-gl@2/dist/echarts-gl.min.js"></script>
</head>
<body>

<div id="main"></div>
<div id="switcher">Changer fond : Jour/Nuit</div>

<script>
(async function(){
  try {
    const earthTexture = './earth.jpg';
    const nightTexture = './night.jpg';
    const cloudTexture = './clouds.png';

    const chart = echarts.init(document.getElementById('main'));

    async function loadGeojson(url) {
      const res = await fetch(url);
      if(!res.ok) throw new Error("Erreur chargement " + url);
      return await res.json();
    }

    const countries = await loadGeojson('./countries_10m_new.geojson');
    const capitals = await loadGeojson('./capitals.geojson');

    // Frontières pays
    const countryLines = [];
    countries.features.forEach(feature => {
      if(!feature.geometry) return;
      if(feature.geometry.type === 'MultiPolygon') {
        feature.geometry.coordinates.forEach(polygon => {
          polygon.forEach(ring => {
            countryLines.push({
              coords: ring.map(c => [c[0], c[1]]),
              lineStyle: { color: '#fff', width: 1 }
            });
          });
        });
      } else if(feature.geometry.type === 'Polygon') {
        feature.geometry.coordinates.forEach(ring => {
          countryLines.push({
            coords: ring.map(c => [c[0], c[1]]),
            lineStyle: { color: '#fff', width: 1 }
          });
        });
      }
    });

    // Capitales (petits points blancs avec contour noir)
    const capitalPoints = capitals.features.map(f => ({
      name: f.properties.name || '',
      value: [f.geometry.coordinates[0], f.geometry.coordinates[1], 0],
      symbolSize: 4,
      itemStyle: {
        color: '#fff',
        borderColor: '#000',
        borderWidth: 1,
        opacity: 0.8
      }
    }));

    // Pour simuler position lune, on utilise longitude et latitude fixe ici (exemple)
    // Pour une vraie position, faudra intégrer calcul astronomie (ex: suncalc ou astronomia)
    const moonPos = {
      lon: 134, // exemple
      lat: 13
    };

    // Convertir lon/lat lune en XYZ (rayon globe = 100)
    function lonLatToCartesian(lon, lat, radius=100) {
      const radLon = (lon * Math.PI) / 180;
      const radLat = (lat * Math.PI) / 180;
      const x = radius * Math.cos(radLat) * Math.cos(radLon);
      const y = radius * Math.sin(radLat);
      const z = radius * Math.cos(radLat) * Math.sin(radLon);
      return [x, y, z];
    }

    // Affichage lune
    const moonScatter = {
      name: 'Lune',
      type: 'scatter3D',
      coordinateSystem: 'globe',
      symbol: 'circle',
      symbolSize: 15,
      itemStyle: {
        color: '#ccc',
        opacity: 1,
        borderColor: '#888',
        borderWidth: 1
      },
      data: [moonPos.lon, moonPos.lat, 105] // légèrement au dessus surface globe
    };

    // Option de base
    let currentBaseTexture = earthTexture;
    let currentNightTexture = nightTexture;

    const optionBase = {
      backgroundColor: 'transparent',
      globe: {
        baseTexture: currentBaseTexture,
        nightTexture: currentNightTexture,
        shading: 'lambert',
        postEffect: { enable: true },
        light: { main: { intensity: 1, shadow: true, shadowQuality: 'high' }, ambient: { intensity: 0.1 } },
        viewControl: { autoRotate: true, autoRotateSpeed: 3 },
        layers: [
          {
            type: 'overlay',
            texture: cloudTexture,
            shading: 'lambert',
            distance: 2.0,
            blendTo: 'emission',
            // rotation simulée, changée par un timer
            // On verra en dessous
          }
        ]
      },
      series: [
        {
          name: 'Pays',
          type: 'lines3D',
          coordinateSystem: 'globe',
          blendMode: 'lighter',
          lineStyle: { width: 1, opacity: 0.9 },
          data: countryLines
        },
        {
          name: 'Capitales',
          type: 'scatter3D',
          coordinateSystem: 'globe',
          symbol: 'circle',
          symbolSize: 4,
          itemStyle: { color: '#fff', borderColor: '#000', borderWidth: 1, opacity: 0.8 },
          data: capitalPoints
        },
        moonScatter
      ]
    };

    chart.setOption(optionBase);

    // Rotation nuages simulée
    let cloudRotation = 0;
    setInterval(() => {
      cloudRotation += 0.05;
      chart.setOption({
        globe: {
          layers: [{
            rotation: cloudRotation
          }]
        }
      });
    }, 50);

    // Gestion du bouton changement fond
    document.getElementById('switcher').addEventListener('click', () => {
      if(currentBaseTexture === earthTexture){
        currentBaseTexture = nightTexture;
        currentNightTexture = earthTexture;
      } else {
        currentBaseTexture = earthTexture;
        currentNightTexture = nightTexture;
      }
      chart.setOption({
        globe: {
          baseTexture: currentBaseTexture,
          nightTexture: currentNightTexture
        }
      });
    });

    // Ajuster la taille des capitales en fonction du zoom
    chart.getZr().on('mousewheel', () => {
      const viewControl = chart.getModel().getComponent('globe').getViewControl();
      const dist = viewControl.distance; // la distance actuelle à la caméra
      // Exemple d’adaptation simple
      const size = Math.min(10, Math.max(2, 100 / dist));
      chart.setOption({
        series: [{
          name: 'Capitales',
          symbolSize: size
        }]
      });
    });

  } catch(e) {
    console.error("Erreur dans le script:", e);
  }
})();
</script>

</body>
</html>
